<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>CppDB: Using Connection Pool</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">CppDB
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="index.html">CppDB - SQL Connectivity Library</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">Using Connection Pool </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="pool_using"></a>
Using Connection Pooling</h2>
<p>CppDB provides two ways to use connection pooling:</p>
<ol type="1">
<li>Transparent - by setting a connection string option "@pool_size=N" where N is positive integer.</li>
<li>Direct - by using <a class="el" href="classcppdb_1_1pool.html" title="Connections pool, allows to handle multiple connections for specific connection string.">cppdb::pool</a> object directly.</li>
</ol>
<p>The first is the most simple case, it works fully transparently and only thing that should be changed is a connection string. Such that</p>
<div class="fragment"><pre class="fragment"><a class="code" href="classcppdb_1_1session.html" title="SQL session object that represents a single connection and is the gateway to SQL database.">cppdb::session</a> sql(<span class="stringliteral">&quot;sqlite3:db=test.db;@pool_size=10&quot;</span>);
</pre></div><p>Would automatically use connections pool and not require using any additional effort.</p>
<p>On the other hand it has its own downsides - use of global singleton instance of the connections. It may give a chance that unrelated components of same software that use same connection string may interfere each other, set different connection options, etc.</p>
<p>So libraries should prefer to use explicit pool object.</p>
<div class="fragment"><pre class="fragment"><span class="comment">// Create the pool</span>
<a class="code" href="classcppdb_1_1ref__ptr.html">cppdb::pool::pointer</a> my_pool = <a class="code" href="classcppdb_1_1pool.html#a5f0d996be0a4da7750edb2c00d3f6a78" title="Create new pool for connection_string.">cppdb::pool::create</a>(<span class="stringliteral">&quot;sqlite3:db=test.db&quot;</span>);

<span class="comment">// Use the pool</span>
<a class="code" href="classcppdb_1_1session.html" title="SQL session object that represents a single connection and is the gateway to SQL database.">cppdb::session</a> sql(my_pool-&gt;<a class="code" href="classcppdb_1_1pool.html#aae9914b4323d982c49c4604b0696ecb0">open</a>());
<span class="comment">// When sql is destroyed the</span>
<span class="comment">// connection is returned to the pool</span>
</pre></div><p>This allows to use pool outside the global <a class="el" href="classcppdb_1_1connections__manager.html">cppdb::connections_manager</a>.</p>
<h2><a class="anchor" id="pool_conn_opt"></a>
Configuring a Connection</h2>
<p>It is useful to be able to setup some generic session options that are usually set only once and kept during all the session. It may be things like transaction isolation level, durability options and more.</p>
<p>When you use connections pool it would be very useful to distinguish between the newly created connection and other, recycled from the pool.</p>
<p>It can be done using <a class="el" href="classcppdb_1_1session.html#a47dce585a6f56021431060308e6b0028">cppdb::session::once_called()</a> member function or simply by using <a class="el" href="classcppdb_1_1session.html#a2e7a76fe14418446e7154662d809f314">cppdb::session::once()</a> function with a callback that is promised to be called only once per new connection.</p>
<p>For example:</p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">void</span> config(<a class="code" href="classcppdb_1_1session.html" title="SQL session object that represents a single connection and is the gateway to SQL database.">cppdb::session</a> &amp;sql)
{
  sql &lt;&lt; <span class="stringliteral">&quot;PRAGMA read_uncommited=1&quot;</span> &lt;&lt; <a class="code" href="namespacecppdb.html#a4ef7108015eb01d87073d5dc0f55488c" title="Manipulator that causes statement execution. Used as:">cppdb::exec</a>;
}
...

cppdb::session sql(conn_str);
sql.once(config); <span class="comment">// called for new connections only</span>
sql &lt;&lt; ... ;
</pre></div><p>Please note that any function like object that receive as a parameter the sql sesion can be used as callback:</p>
<div class="fragment"><pre class="fragment"><span class="keyword">struct </span>config {
  <span class="keywordtype">int</span> uncommited;
  <span class="keywordtype">void</span> operator()(<a class="code" href="classcppdb_1_1session.html" title="SQL session object that represents a single connection and is the gateway to SQL database.">cppdb::session</a> &amp;sql) <span class="keyword">const</span> <span class="comment">// operator ()</span>
  {
    sql &lt;&lt; <span class="stringliteral">&quot;PRAGMA read_uncommited=?&quot;</span> &lt;&lt; uncommited &lt;&lt; cppdb::exec;
  }
  config(<span class="keywordtype">int</span> val ) : uncommited(val)
  {
  }
};

...
cppdb::session sql(conn_str);
sql.once(config(commit_mode)); <span class="comment">// called for new connections only</span>
sql &lt;&lt; ... ;
</pre></div><h2><a class="anchor" id="pool_conn_specific"></a>
Connection Specific Data</h2>
<p>If more complex configuration of the session is required it is possible to associate any user object with a connection using <a class="el" href="classcppdb_1_1connection__specific__data.html">cppdb::connection_specific_data</a>.</p>
<p>User can derive his own classes from it and store it withing a connection object. For example</p>
<div class="fragment"><pre class="fragment"><span class="keyword">struct </span>my_data : <span class="keyword">public</span> cppdb::connection_specific_data {
  <span class="keywordtype">int</span> foo;
  std::string bar 
};
...

my_data *p=sql.get_specific&lt;my_data&gt;();
<span class="comment">// check if it exists</span>
<span class="keywordflow">if</span>(!p) { 
   <span class="comment">// if not create one and assign one</span>
   p = <span class="keyword">new</span> my_data();
   sql.reset_specific(p);
}
p-&gt;foo++;
...
</pre></div> </div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Sat Jun 23 2012 12:36:59 for CppDB by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
